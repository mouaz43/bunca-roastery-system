<%
  var safeActivity = (typeof activity !== "undefined" && activity) ? activity : [];
  var f = (typeof filters !== "undefined" && filters) ? filters : { search:"", area:"ALL", range:"7" };

  function badgeFor(action){
    if (!action) return { cls:"badge", txt:"Info" };
    if (action.indexOf("DELETE") >= 0) return { cls:"badge danger", txt:"Löschen" };
    if (action.indexOf("STATUS") >= 0) return { cls:"badge warn", txt:"Status" };
    if (action.indexOf("INVENTORY") >= 0) return { cls:"badge ok", txt:"Lager" };
    if (action.indexOf("BATCH") >= 0) return { cls:"badge warn", txt:"Charge" };
    if (action.indexOf("ORDER_CREATE") >= 0) return { cls:"badge ok", txt:"Neu" };
    return { cls:"badge", txt:"Info" };
  }

  function shortId(id){
    if (!id) return "-";
    return (String(id).length >= 8) ? String(id).slice(0,8) : String(id);
  }

  function fmt(at){
    if (!at) return "-";
    return String(at).slice(0,19).replace("T"," ");
  }

  function metaText(m){
    if (!m) return "-";
    if (m.orderId) return "Bestellung " + shortId(m.orderId);
    if (m.batchId) return "Charge " + shortId(m.batchId);
    if (m.coffeeId) return "Sorte " + m.coffeeId;
    return "-";
  }
%>

<div class="card-grid">
  <div class="card">
    <h2>Aktivität</h2>
    <p>Audit Log. Nutzen Sie Filter, um schnell Vorgänge zu finden.</p>
  </div>
  <div class="card">
    <h2>Warum wichtig</h2>
    <p>Wenn Zahlen nicht stimmen: hier sehen Sie wer was wann geändert hat.</p>
  </div>
</div>

<div style="margin-top:14px;" class="filterbar">
  <form method="GET" action="/activity" class="filter-left" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input class="input" name="q" value="<%= f.search %>" placeholder="Suche (ID, Aktion, Sorte)" />

    <select class="select" name="area">
      <option value="ALL" <%= (f.area==="ALL"?"selected":"") %>>Bereich: Alle</option>
      <option value="ORDERS" <%= (f.area==="ORDERS"?"selected":"") %>>Bestellungen</option>
      <option value="INVENTORY" <%= (f.area==="INVENTORY"?"selected":"") %>>Lager</option>
      <option value="BATCHES" <%= (f.area==="BATCHES"?"selected":"") %>>Chargen</option>
    </select>

    <select class="select" name="range">
      <option value="1" <%= (f.range==="1"?"selected":"") %>>Zeitraum: Heute</option>
      <option value="7" <%= (f.range==="7"?"selected":"") %>>7 Tage</option>
      <option value="30" <%= (f.range==="30"?"selected":"") %>>30 Tage</option>
      <option value="90" <%= (f.range==="90"?"selected":"") %>>90 Tage</option>
    </select>

    <button class="btn btn-secondary" type="submit">Filtern</button>
    <a class="btn btn-ghost" href="/activity">Reset</a>
  </form>

  <div class="filter-right">
    <span class="small-note">Einträge: <%= safeActivity.length %></span>
  </div>
</div>

<div style="margin-top:14px;" class="table-wrap">
  <div class="table-head" style="grid-template-columns: 170px 220px 1fr 1fr 180px;">
    <div>Zeit</div>
    <div>Typ</div>
    <div>Referenz</div>
    <div>Details</div>
    <div>Status</div>
  </div>

  <% if (!safeActivity.length) { %>
    <div class="table-row" style="grid-template-columns: 170px 220px 1fr 1fr 180px;">
      <div>-</div>
      <div>-</div>
      <div>Keine Aktivität (Filter prüfen)</div>
      <div>-</div>
      <div><span class="badge"><span class="dot"></span>Info</span></div>
    </div>
  <% } %>

  <% for (var i=0; i<safeActivity.length; i++) {
      var a = safeActivity[i];
      var b = badgeFor(a.action || "");
      var meta = a.meta || {};
  %>
    <div class="table-row" style="grid-template-columns: 170px 220px 1fr 1fr 180px;">
      <div class="mono"><%= fmt(a.at) %></div>
      <div><strong><%= a.action %></strong></div>
      <div class="small-note"><%= metaText(meta) %></div>
      <div class="small-note"><%= JSON.stringify(meta) %></div>
      <div><span class="<%= b.cls %>"><span class="dot"></span><%= b.txt %></span></div>
    </div>
  <% } %>
</div>

<div style="margin-top:14px;" class="card card-wide">
  <h2>Erklärung</h2>
  <p>Filtern Sie nach Bereich und Zeitraum. So finden Sie Fehlerquellen in Sekunden statt Minuten.</p>
</div>
