<%
  var safeDemand = (typeof roastDemand !== "undefined" && roastDemand) ? roastDemand : [];
  var safeInventory = (typeof inventory !== "undefined" && inventory) ? inventory : null;
  var safeBatches = (typeof batches !== "undefined" && batches) ? batches : [];

  function getGreen(coffeeId){
    if (!safeInventory || !safeInventory.greenBeansKg) return 0;
    var v = safeInventory.greenBeansKg[coffeeId];
    if (v === undefined || v === null) return 0;
    return v;
  }

  function getRoasted(coffeeId){
    if (!safeInventory || !safeInventory.roastedKg) return 0;
    var v = safeInventory.roastedKg[coffeeId];
    if (v === undefined || v === null) return 0;
    return v;
  }

  function badgeRisk(needFromGreen, green){
    if (needFromGreen <= 0) return { cls:"badge ok", txt:"Puffer vorhanden" };
    if (green >= needFromGreen) return { cls:"badge ok", txt:"Rohkaffee ausreichend" };
    if (green > 0 && green < needFromGreen) return { cls:"badge warn", txt:"Rohkaffee knapp" };
    return { cls:"badge danger", txt:"Rohkaffee fehlt" };
  }

  function batchBadge(status){
    if (status === "GEPLANT") return { cls:"badge warn", txt:"Geplant" };
    if (status === "GEROESTET") return { cls:"badge ok", txt:"Geröstet" };
    if (status === "ABGEKUEHLT") return { cls:"badge", txt:"Abgekühlt" };
    if (status === "VERPACKT") return { cls:"badge ok", txt:"Verpackt" };
    if (status === "BEREIT") return { cls:"badge", txt:"Bereit" };
    if (status === "AUSGELIEFERT") return { cls:"badge", txt:"Ausgeliefert" };
    return { cls:"badge", txt: status || "-" };
  }
%>

<div class="card-grid">
  <div class="card">
    <h2>Produktion</h2>
    <p>Bedarf aus freigegebenen Bestellungen, Abgleich mit Lager, danach Chargen planen und verfolgen.</p>
  </div>

  <div class="card">
    <h2>Regel</h2>
    <p>Wenn eine Charge auf “Geröstet” geht, wird Rohkaffee reduziert und Röstkaffee erhöht (gleiche kg).</p>
  </div>

  <div class="card">
    <h2>Schnellaktionen</h2>
    <p>Alles hängt zusammen. Nutzen Sie diese Sprünge für den Alltag.</p>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-secondary" href="/orders">Bestellungen</a>
      <a class="btn btn-secondary" href="/inventory">Lager</a>
      <a class="btn btn-ghost" href="/analytics">Analysen</a>
    </div>
  </div>

  <div class="card">
    <h2>Hinweis</h2>
    <p>In diesem Schritt speichern wir Chargen in Memory. Danach folgt DB und echtes Protokoll.</p>
  </div>
</div>

<div style="margin-top:14px;" class="table-wrap">
  <div class="table-head">
    <div>Sorte</div>
    <div>Bedarf kg</div>
    <div>Röstkaffee kg</div>
    <div>Rohkaffee kg</div>
    <div>Status</div>
    <div>Batch</div>
  </div>

  <% if (!safeDemand.length) { %>
    <div class="table-row">
      <div>Kein Bedarf</div>
      <div>-</div>
      <div>-</div>
      <div>-</div>
      <div><span class="badge"><span class="dot"></span>Warten auf Freigaben</span></div>
      <div class="row-actions">
        <a class="btn btn-primary" href="/orders">Zu Bestellungen</a>
      </div>
    </div>
  <% } %>

  <% for (var i=0; i<safeDemand.length; i++) {
      var r = safeDemand[i];
      var green = getGreen(r.coffeeId);
      var roasted = getRoasted(r.coffeeId);

      var needFromGreen = r.kg - roasted;
      if (needFromGreen < 0) needFromGreen = 0;

      var risk = badgeRisk(needFromGreen, green);
  %>
    <div class="table-row">
      <div><strong><%= r.coffeeName %></strong></div>
      <div><%= r.kg %></div>
      <div><%= roasted %></div>
      <div><%= green %></div>
      <div><span class="<%= risk.cls %>"><span class="dot"></span><%= risk.txt %></span></div>
      <div class="row-actions">
        <form method="POST" action="/actions/batches/create" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input type="hidden" name="coffeeId" value="<%= r.coffeeId %>" />
          <input class="input" name="kg" style="width:140px;" placeholder="kg (z.B. 12)" />
          <input class="input" name="note" style="width:220px;" placeholder="Notiz (optional)" />
          <button class="btn btn-primary" type="submit">Charge anlegen</button>
        </form>
      </div>
    </div>
  <% } %>
</div>

<div style="margin-top:14px;" class="table-wrap">
  <div class="table-head" style="grid-template-columns: 120px 1fr 140px 170px 1fr 280px;">
    <div>ID</div>
    <div>Sorte</div>
    <div>kg</div>
    <div>Status</div>
    <div>Notiz</div>
    <div>Aktionen</div>
  </div>

  <% if (!safeBatches.length) { %>
    <div class="table-row" style="grid-template-columns: 120px 1fr 140px 170px 1fr 280px;">
      <div class="mono">-</div>
      <div>Keine Chargen</div>
      <div>-</div>
      <div><span class="badge"><span class="dot"></span>Info</span></div>
      <div>-</div>
      <div class="row-actions">
        <span class="small-note">Erstellen Sie oben eine Charge aus dem Bedarf.</span>
      </div>
    </div>
  <% } %>

  <% for (var b=0; b<safeBatches.length; b++) {
      var x = safeBatches[b];
      var bb = batchBadge(x.status);
      var sid = (x.id && x.id.length >= 8) ? x.id.slice(0,8) : (x.id || "-");
  %>
    <div class="table-row" style="grid-template-columns: 120px 1fr 140px 170px 1fr 280px;">
      <div class="mono"><%= sid %></div>
      <div><strong><%= x.coffeeName %></strong></div>
      <div><%= x.kg %></div>
      <div><span class="<%= bb.cls %>"><span class="dot"></span><%= bb.txt %></span></div>
      <div class="small-note"><%= x.note ? x.note : "-" %></div>
      <div class="row-actions">
        <form method="POST" action="/actions/batches/<%= x.id %>/advance">
          <button class="btn btn-primary" type="submit">Status weiter</button>
        </form>
        <form method="POST" action="/actions/batches/<%= x.id %>/delete" onsubmit="return confirm('Charge wirklich löschen?');">
          <button class="btn btn-danger" type="submit">Löschen</button>
        </form>
      </div>
    </div>
  <% } %>
</div>

<div style="margin-top:14px;" class="card card-wide">
  <h2>Was passiert automatisch?</h2>
  <p>Wenn Sie den Batch-Status auf “Geröstet” setzen, wird der Rohkaffee reduziert und der Röstkaffee erhöht. Das ist die Grundlage für eine echte Lagerlogik.</p>
</div>
